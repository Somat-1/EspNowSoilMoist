// ESP-NOW RECEIVER (HUB) - ESP32-C3
// This code should run on your main hub/controller ESP32
// Rename this file to main.cpp in a separate hub project

#include <Arduino.h>
#include <esp_now.h>
#include <WiFi.h>

// Data structure to receive (must match sender)
typedef struct sensor_data_t {
  float batteryVoltage;
  int batteryPercent;
  int soilMoisture;
  unsigned long timestamp;
} sensor_data_t;

sensor_data_t receivedData;

// Store MAC address of sender for identification
uint8_t senderMac[6];

// Callback when data is received
void onDataRecv(const uint8_t *mac, const uint8_t *incomingData, int len) {
  memcpy(&receivedData, incomingData, sizeof(receivedData));
  memcpy(senderMac, mac, 6);
  
  Serial.println("\n=== Data Received ===");
  Serial.printf("From MAC: %02X:%02X:%02X:%02X:%02X:%02X\n",
                mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
  Serial.printf("Battery: %.2f V (%d%%)\n", 
                receivedData.batteryVoltage, receivedData.batteryPercent);
  Serial.printf("Soil Moisture: %d%%\n", receivedData.soilMoisture);
  Serial.printf("Timestamp: %lu ms\n", receivedData.timestamp);
  Serial.println("====================\n");
  
  // Here you can add code to:
  // - Send data to cloud/MQTT
  // - Display on LCD/OLED
  // - Store in database
  // - Trigger alerts if moisture too low
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n=== ESP-NOW Receiver Hub ===");
  
  // Set device as a Wi-Fi Station
  WiFi.mode(WIFI_STA);
  
  // Print MAC address
  Serial.print("Hub MAC Address: ");
  Serial.println(WiFi.macAddress());
  Serial.println("Copy this MAC address to the sender code!");
  Serial.println();
  
  // Initialize ESP-NOW
  if (esp_now_init() != ESP_OK) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }
  
  Serial.println("ESP-NOW initialized successfully");
  
  // Register callback function
  esp_now_register_recv_cb(onDataRecv);
  
  Serial.println("Waiting for data...\n");
}

void loop() {
  // Nothing to do here - callback handles everything
  delay(1000);
}
